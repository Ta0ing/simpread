> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [www.cnblogs.com](https://www.cnblogs.com/ybit/p/14918949.html)

CVE-2021-22205
==============

> `RCE` on `Gitlab` `version < 13.10.3`

一、根本原因
------

*   当上传图片文件时，`Gitlab Workhorse`将扩展名为`jpg|jpeg|tiff`的文件通过`ExifTool`删除任何非白名单标记。
*   其中一个支持的格式是`DjVu`。当解析`DjVu`注释时，标记被赋值为`convert C escape sequences`。
*   作者的文章：`https://devcraft.io/2021/05/04/exiftool-arbitrary-code-execution-cve-2021-22204.html` _（详情请看此处）_

```
#convert C escape sequences 出现以下代码
$tok = eval qq{"$tok"}; 
```

二、漏洞复现
------

1.  首先需要一个`Gitlab`平台的一个账户及密码（有些公司的Gitlab平台是允许注册的）  
    ![register](https://img2020.cnblogs.com/blog/2419409/202106/2419409-20210622155316993-1832205813.png)
    
2.  登录后到个人主页，找到`Snippets`
    
    ![1](https://img2020.cnblogs.com/blog/2419409/202106/2419409-20210622155353460-1776963451.png)
    
    ![](https://img2020.cnblogs.com/blog/2419409/202106/2419409-20210622155423078-1066231630.png)
    
    ![](https://img2020.cnblogs.com/blog/2419409/202106/2419409-20210622155433466-105801240.png)
    
3.  此处需要上传`DjVu`格式图片（即Exp）
    
    *   `DjVu`格式图片制作方式如下
        
        1.  下载安装`DjVuLibre` 地址`http://djvu.sourceforge.net/`
            
        2.  准备好将要压缩图片的文本
            
            ![](https://img2020.cnblogs.com/blog/2419409/202106/2419409-20210622155456757-972141918.png)
            
            ![](https://img2020.cnblogs.com/blog/2419409/202106/2419409-20210622155512640-656920564.png)
            
        3.  使用命令`djvumake rce.djvu INFO=0,0 BGjp=/dev/null ANTa=rce.txt && mv rce.djvu rce.jpg` 生成Exp
            
            ![](https://img2020.cnblogs.com/blog/2419409/202106/2419409-20210622155525396-817668719.png)
            
4.  上传`Exp`
    
    ![](https://img2020.cnblogs.com/blog/2419409/202106/2419409-20210622155535259-59170096.png)
    
5.  成功执行
    
    ![](https://img2020.cnblogs.com/blog/2419409/202106/2419409-20210622155544816-1119053117.png)